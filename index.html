<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebAR con MindAR ‚Äì Image Tracking (covid.glb + targets.mind)</title>

    <!-- 1) A-Frame (CDN principal) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.5.0/aframe.min.js"></script>
    <!-- 1b) Fallback a unpkg si el anterior falla/capado -->
    <script>
      if (!window.AFRAME) {
        const s = document.createElement('script');
        s.src = 'https://unpkg.com/aframe@1.5.0/dist/aframe.min.js';
        document.head.appendChild(s);
      }
    </script>

    <!-- 2) Cargar MindAR *solo* cuando AFRAME exista -->
    <script>
      function loadMindAR() {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
        s.onload = () => console.log('[MindAR] cargado');
        s.onerror = () => logLine('‚ùå No se pudo cargar MindAR (CDN). Revisa conexi√≥n/CDN.');
        document.head.appendChild(s);
      }
      (function waitForAF() {
        if (window.AFRAME) loadMindAR();
        else setTimeout(waitForAF, 50);
      })();
    </script>

    <style>
      html,body{margin:0;height:100%;background:#000;}
      #ui {position: fixed; top: 12px; left: 12px; right: 12px; z-index: 3; display:flex; gap:8px; align-items:center; font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
      #ui .chip{background:#00000090;color:#fff;padding:8px 10px;border-radius:10px;backdrop-filter: blur(6px);}
      #help{position: fixed; bottom: 12px; left: 12px; right: 12px; z-index: 3; text-align:center; color:#fff; opacity:.85; font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
      .badge {position: fixed; top: 12px; right: 12px; z-index: 4; background:#ffffff15; color:#fff; padding:6px 10px; border-radius:10px; font: 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
      #log { position: fixed; left: 12px; bottom: 56px; right: 12px; z-index: 4; color:#0ff; font:12px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; background:#001014b3; padding:8px 10px; border-radius:10px; max-height: 40vh; overflow:auto; }
      #loading {position: fixed; inset: 0; z-index: 2; display:grid; place-items:center; color:#fff; font: 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:linear-gradient(180deg,#000 0%,#0a0f14 100%);}
      #loading.hidden{display:none;}
    </style>
  </head>
  <body>
    <div id="ui">
      <div class="chip">Apunta la c√°mara al <b>marcador impreso</b></div>
      <div class="chip">Toca/arrastra para girar ‚Ä¢ Pinza para zoom</div>
    </div>
    <div class="badge">MindAR build</div>
    <div id="loading">Cargando‚Ä¶ recuerda permitir la <b>c√°mara</b></div>
    <div id="log"></div>

    <!-- 3) Escena A-Frame + MindAR -->
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001"
      vr-mode-ui="enabled:false"
      device-orientation-permission-ui="enabled:true"
      renderer="colorManagement:true; physicallyCorrectLights:true"
      embedded
    >
      <a-assets>
        <a-asset-item id="m" src="./covid.glb"></a-asset-item>
      </a-assets>

      <!-- Luces b√°sicas -->
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="1 1 1"></a-entity>

      <!-- targetIndex:0 corresponde a la 1¬™ imagen incluida en targets.mind -->
      <a-entity id="anchor" mindar-image-target="targetIndex: 0">
        <!-- Ajusta escala/posici√≥n/rotaci√≥n a tu marcador f√≠sico -->
        <a-gltf-model id="model" src="#m" position="0 0 0" rotation="0 0 0" scale="0.2 0.2 0.2"></a-gltf-model>
      </a-entity>

      <a-camera position="0 0 0"></a-camera>
    </a-scene>

    <div id="help">Si no aparece la c√°mara: usa Chrome/Safari nativos (no dentro de Instagram), entra por <b>https</b>, quita modo inc√≥gnito y permite la c√°mara.</div>

    <!-- 4) Utilidades de depuraci√≥n / gestos -->
    <script>
      // Logger visible en pantalla
      function logLine(msg){
        const log = document.getElementById('log');
        const t = new Date().toLocaleTimeString();
        log.textContent += `[${t}] ${msg}\n`;
        log.scrollTop = log.scrollHeight;
        console.log(msg);
      }

      // Captura errores JS
      window.addEventListener('error', e => logLine(`‚ùå JS error: ${e.message}`));
      window.addEventListener('unhandledrejection', e => logLine(`‚ùå Promise error: ${e.reason && e.reason.message ? e.reason.message : e.reason}`));

      // Cuando A-Frame cree el canvas, conectamos interacciones y chequeos
      document.addEventListener('DOMContentLoaded', () => {
        const scene = document.querySelector('a-scene');
        const loading = document.getElementById('loading');
        const anchor = document.getElementById('anchor');

        // Debug de tracking
        anchor.addEventListener('targetFound', () => logLine('üîµ target FOUND'));
        anchor.addEventListener('targetLost',  () => logLine('‚ö™ target LOST'));

        // Se√±al de c√°mara activa (A-Frame emite evento webgltextureloaded cuando el v√≠deo est√° en uso)
        scene.addEventListener('loaded', () => {
          logLine('‚úÖ Escena A-Frame cargada');
          // Espera a que el canvas exista
          setTimeout(() => {
            const canvas = document.querySelector('canvas');
            if (canvas) {
              logLine('üé• Intentando iniciar c√°mara‚Ä¶');
              // Ocultar loading cuando detectemos primer frame (pr√°ctico)
              let hid = false;
              const hideOnce = ()=>{ if(!hid){ loading.classList.add('hidden'); hid=true; logLine('üé¨ C√°mara activa'); } };
              canvas.addEventListener('webglcontextrestored', hideOnce);
              // fallback si no dispara el evento (por si acaso)
              setTimeout(hideOnce, 1500);

              // Gestos
              const model = document.getElementById('model');
              let lastX=0,lastY=0, dragging=false;
              canvas.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY;});
              canvas.addEventListener('pointerup',   ()=> dragging=false);
              canvas.addEventListener('pointermove', e=>{
                if(!dragging) return;
                const dx = e.clientX - lastX; const dy = e.clientY - lastY;
                lastX = e.clientX; lastY = e.clientY;
                const r = model.getAttribute('rotation');
                model.setAttribute('rotation', {x: r.x + dy*0.2, y: r.y + dx*0.3, z: r.z});
              });

              let lastDist=0; let scale=0.2;
              const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
              window.addEventListener('touchmove', e=>{
                if(e.touches && e.touches.length===2){
                  const [a,b]=e.touches; const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY;
                  const dist=Math.hypot(dx,dy);
                  if(lastDist){
                    const delta = (dist-lastDist)/5000;
                    scale = clamp(scale + delta, 0.05, 2.5);
                    model.setAttribute('scale', `${scale} ${scale} ${scale}`);
                  }
                  lastDist=dist;
                }
              }, {passive:true});
              window.addEventListener('touchend', ()=>{ lastDist=0; });
            } else {
              logLine('‚ö†Ô∏è No se encontr√≥ el canvas a√∫n.');
            }
          }, 300);
        });

        // Comprobaci√≥n de permisos de c√°mara directa (ayuda a diagnosticar)
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(s => { s.getTracks().forEach(t=>t.stop()); logLine('üîì Permiso de c√°mara OK'); })
            .catch(err => logLine(`üîí C√°mara bloqueada: ${err && err.name ? err.name : err}`));
        } else {
          logLine('‚ùå getUserMedia no disponible en este navegador.');
        }
      });
    </script>
  </body>
</html>
