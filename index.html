<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebAR con MindAR – Image Tracking</title>

    <!-- A-Frame + MindAR (image tracking en navegador móvil, sin apps extra) -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html,body{margin:0;height:100%;}
      #ui {position: fixed; top: 12px; left: 12px; right: 12px; z-index: 2; display:flex; gap:8px; align-items:center; font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
      #ui .chip{background:#00000090;color:#fff;padding:8px 10px;border-radius:10px;backdrop-filter: blur(6px);}      
      #help{position: fixed; bottom: 12px; left: 12px; right: 12px; z-index: 2; text-align:center; color:#fff; opacity:.85; font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    </style>
  </head>
  <body>
    <div id="ui">
      <div class="chip">Apunta la cámara al <b>marcador impreso</b></div>
      <div class="chip">Toca y arrastra para girar • Pinza para zoom</div>
    </div>

    <!--
      Coloca estos archivos en la raíz del repo (misma carpeta de este index.html):
        - model.glb        → tu modelo 3D
        - myTarget.mind    → archivo del marcador generado con MindAR
        - marker.png/jpg   → la imagen del marcador que vas a imprimir
      Tip: si cambias los nombres, actualízalos abajo.
    -->

    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001"
      vr-mode-ui="enabled:false"
      device-orientation-permission-ui="enabled:true"
      renderer="colorManagement:true; physicallyCorrectLights:true"
      embedded
    >
      <a-assets>
        <a-asset-item id="m" src="./covid.glb"></a-asset-item>
      </a-assets>

      <!-- Luces básicas -->
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="1 1 1"></a-entity>

      <!-- targetIndex: 0 corresponde a la 1ª imagen de myTarget.mind -->
      <a-entity id="anchor" mindar-image-target="targetIndex: 0">
        <!-- Ajusta escala/posición/rotación a tu marcador físico -->
        <a-gltf-model id="model" src="#m" position="0 0 0" rotation="0 0 0" scale="0.2 0.2 0.2"></a-gltf-model>
      </a-entity>

      <a-camera position="0 0 0"></a-camera>
    </a-scene>

    <div id="help">Si no aparece, mueve la cámara, evita brillos, y acerca el marcador al centro. Marcador recomendado mate y con alto contraste.</div>

    <script>
      // Interacciones básicas: rotación y zoom por gesto
      (function(){
        const model = document.getElementById('model');
        let lastX=0,lastY=0, dragging=false, scale=0.2;
        const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));

        const canvas = document.querySelector('canvas');
        const get = (e)=> (e.touches? e.touches[0]: e);

        canvas.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY;});
        canvas.addEventListener('pointerup',   ()=> dragging=false);
        canvas.addEventListener('pointermove', e=>{
          if(!dragging) return;
          const dx = e.clientX - lastX; const dy = e.clientY - lastY;
          lastX = e.clientX; lastY = e.clientY;
          const r = model.getAttribute('rotation');
          model.setAttribute('rotation', {x: r.x + dy*0.2, y: r.y + dx*0.3, z: r.z});
        });

        let lastDist=0;
        window.addEventListener('touchmove', e=>{
          if(e.touches.length===2){
            const [a,b]=e.touches; const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY;
            const dist=Math.hypot(dx,dy);
            if(lastDist){
              const delta = (dist-lastDist)/5000; // sensibilidad
              scale = clamp(scale + delta, 0.05, 2.5);
              model.setAttribute('scale', `${scale} ${scale} ${scale}`);
            }
            lastDist=dist;
          }
        }, {passive:true});
        window.addEventListener('touchend', ()=>{ lastDist=0; });
      })();
    </script>
  </body>
</html>
