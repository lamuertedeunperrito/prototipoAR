<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebAR con MindAR ‚Äì Image Tracking (covid.glb + targets.mind)</title>

    <!-- A-Frame + MindAR (image tracking en navegador m√≥vil, sin apps extra) -->
    <!-- 1) Carga A-Frame desde CDNJS (m√°s confiable en algunos ISP) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.5.0/aframe.min.js"></script>
<!-- 1b) Fallback opcional a unpkg si el anterior falla -->
<script>
  if(!window.AFRAME){
    var s=document.createElement('script');
    s.src='https://unpkg.com/aframe@1.5.0/dist/aframe.min.js';
    document.head.appendChild(s);
  }
</script>

<!-- 2) Luego MindAR (depende de A-Frame). Esperamos a que AFRAME exista -->
<script>
  function loadMindAR(){
    var s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js';
    document.head.appendChild(s);
  }
  (function waitForAF(){
    if(window.AFRAME){ loadMindAR(); }
    else { setTimeout(waitForAF, 50); }
  })();
</script>

    <style>
      html,body{margin:0;height:100%;}
      #ui {position: fixed; top: 12px; left: 12px; right: 12px; z-index: 2; display:flex; gap:8px; align-items:center; font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
      #ui .chip{background:#00000090;color:#fff;padding:8px 10px;border-radius:10px;backdrop-filter: blur(6px);}      
      #help{position: fixed; bottom: 12px; left: 12px; right: 12px; z-index: 2; text-align:center; color:#fff; opacity:.85; font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
      .badge {position: fixed; top: 12px; right: 12px; z-index: 3; background:#ffffff15; color:#fff; padding:6px 10px; border-radius:10px; font: 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    </style>
  </head>
  <body>
    <div id="ui">
      <div class="chip">Apunta la c√°mara al <b>marcador impreso</b></div>
      <div class="chip">Toca y arrastra para girar ‚Ä¢ Pinza para zoom</div>
    </div>
    <div class="badge">MindAR build</div>

    <!--
      Archivos esperados en la ra√≠z del repo (misma carpeta que este index.html):
        - covid.glb        ‚Üí tu modelo 3D
        - targets.mind     ‚Üí archivo del marcador generado con MindAR (desde la misma imagen que imprimir√°s)
        - marker.png/jpg   ‚Üí (opcional) la imagen del marcador para que la gente la descargue/imprima
    -->

    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta:0.001"
      vr-mode-ui="enabled:false"
      device-orientation-permission-ui="enabled:true"
      renderer="colorManagement:true; physicallyCorrectLights:true"
      embedded
    >
      <a-assets>
        <a-asset-item id="m" src="./covid.glb"></a-asset-item>
      </a-assets>

      <!-- Luces b√°sicas -->
      <a-entity light="type: ambient; intensity: 1"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="1 1 1"></a-entity>

      <!-- targetIndex: 0 corresponde a la 1¬™ imagen dentro de targets.mind -->
      <a-entity id="anchor" mindar-image-target="targetIndex: 0">
        <!-- Ajusta escala/posici√≥n/rotaci√≥n a tu marcador f√≠sico -->
        <a-gltf-model id="model" src="#m" position="0 0 0" rotation="0 0 0" scale="0.2 0.2 0.2"></a-gltf-model>
      </a-entity>

      <a-camera position="0 0 0"></a-camera>
    </a-scene>

    <div id="help">Si no aparece, mueve la c√°mara, evita brillos, y acerca el marcador al centro. Marcador recomendado mate y con alto contraste.</div>

    <script>
      // Espera a que A-Frame cree el canvas para adjuntar eventos de gesto
      document.querySelector('a-scene').addEventListener('loaded', () => {
        const model  = document.getElementById('model');
        const anchor = document.getElementById('anchor');
        const canvas = document.querySelector('canvas');

        // Debug: saber si el target se detecta
        anchor.addEventListener('targetFound', ()=> console.log('üîµ target FOUND'));
        anchor.addEventListener('targetLost',  ()=> console.log('‚ö™ target LOST'));

        // Rotaci√≥n con arrastre
        let lastX=0,lastY=0, dragging=false;
        canvas.addEventListener('pointerdown', e=>{ dragging=true; lastX=e.clientX; lastY=e.clientY;});
        canvas.addEventListener('pointerup',   ()=> dragging=false);
        canvas.addEventListener('pointermove', e=>{
          if(!dragging) return;
          const dx = e.clientX - lastX; const dy = e.clientY - lastY;
          lastX = e.clientX; lastY = e.clientY;
          const r = model.getAttribute('rotation');
          model.setAttribute('rotation', {x: r.x + dy*0.2, y: r.y + dx*0.3, z: r.z});
        });

        // Zoom con pinza (2 dedos)
        let lastDist=0; let scale=0.2;
        const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
        window.addEventListener('touchmove', e=>{
          if(e.touches && e.touches.length===2){
            const [a,b]=e.touches; const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY;
            const dist=Math.hypot(dx,dy);
            if(lastDist){
              const delta = (dist-lastDist)/5000; // sensibilidad
              scale = clamp(scale + delta, 0.05, 2.5);
              model.setAttribute('scale', `${scale} ${scale} ${scale}`);
            }
            lastDist=dist;
          }
        }, {passive:true});
        window.addEventListener('touchend', ()=>{ lastDist=0; });
      });
    </script>
  </body>
</html>
